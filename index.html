class IslamicFocusTimer {
    constructor() {
        this.sessionDuration = 25 * 60; // 25 minutes in seconds
        this.remainingTime = this.sessionDuration;
        this.isRunning = false;
        this.isPaused = false;
        this.timerInterval = null;
        this.volume = 0.5;
        this.completedMinutes = 0;
        this.sessionsCount = 0;
        this.streakDays = 0;
        this.skipBreaks = false;
        this.isBreakTime = false;
        this.breakDuration = 5 * 60; // Default 5 minutes break
        this.lastSessionDate = null; // Stored as a date string for streak calculation

        // DOM Elements
        this.statusText = document.getElementById("statusText");
        this.timerDisplay = document.getElementById("timerDisplay");
        this.timerLabel = document.getElementById("timerLabel");
        this.progressCircle = document.getElementById("progressCircle");
        this.progressValue = document.getElementById("progressValue");
        this.completedSpan = document.getElementById("completedMinutes");
        this.sessionsSpan = document.getElementById("sessionsCount");
        this.streakSpan = document.getElementById("streakDays");
        this.focusScoreSpan = document.getElementById("focusScore"); // Added for focus score
        this.volumeSlider = document.getElementById("volumeSlider");
        this.volumeValue = document.getElementById("volumeValue");
        this.startBtn = document.getElementById("startBtn");
        this.pauseBtn = document.getElementById("pauseBtn");
        this.resetBtn = document.getElementById("resetBtn");
        this.duaText = document.getElementById("duaText");
        this.mainPanel = document.getElementById("mainPanel");
        this.increaseBtn = document.getElementById("increaseBtn"); // Added for clarity
        this.decreaseBtn = document.getElementById("decreaseBtn"); // Added for clarity
        this.skipBreaksCheckbox = document.getElementById("skipBreaksCheckbox"); // Added for clarity

        // Islamic Content Collections
        this.duas = [
            {
                arabic: "اللَّهُمَّ أَعِنِّي عَلَى ذِكْرِكَ وَشُكْرِكَ وَحُسْنِ عِبَادَتِكَ",
                english: "O Allah, help me remember You, thank You, and worship You in the best manner."
            },
            {
                arabic: "رَبِّ زِدْنِي عِلْمًا",
                english: "My Lord, increase me in knowledge."
            },
            {
                arabic: "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ",
                english: "Our Lord, give us good in this world and good in the hereafter."
            },
            {
                arabic: "حَسْبُنَا اللَّهُ وَنِعْمَ الْوَكِيلُ",
                english: "Allah is sufficient for us and He is the best Disposer of affairs."
            },
            {
                arabic: "وَاللَّهُ خَلَقَكُمْ وَمَا تَعْمَلُونَ",
                english: "And it is Allah who created you and what you do."
            }
        ];

        this.quranVerses = [
            {
                arabic: "وَاذْكُر رَّبَّكَ إِذَا نَسِيتَ",
                english: "And remember your Lord when you forget."
            },
            {
                arabic: "إِنَّ مَعَ الْعُسْرِ يُسْرًا",
                english: "Indeed, with hardship comes ease."
            },
            {
                arabic: "فَإِنَّ مَعَ الْعُسْرِ يُسْرًا * إِنَّ مَعَ الْعُسْرِ يُسْرًا",
                english: "For indeed, with hardship comes ease. Indeed, with hardship comes ease."
            },
            {
                arabic: "وَمَن يَتَّقِ اللَّهَ يَجْعَل لَّهُ مَخْرَجًا",
                english: "And whoever fears Allah - He will make for him a way out."
            },
            {
                arabic: "وَتَوَكَّلْ عَلَى الْحَيِّ الَّذِي لَا يَمُوتُ",
                english: "And rely upon the Ever-Living who does not die."
            }
        ];

        this.hadiths = [
            {
                arabic: "خَيْرُ النَّاسِ أَنْفَعُهُمْ لِلنَّاسِ",
                english: "The best of people are those who are most beneficial to others."
            },
            {
                arabic: "اطْلُبُوا الْعِلْمَ مِنَ الْمَهْدِ إِلَى اللَّحْدِ",
                english: "Seek knowledge from the cradle to the grave."
            },
            {
                arabic: "لَيْسَ الْمُؤْمِنُ الَّذِي يَشْبَعُ وَجَارُهُ جَائِعٌ",
                english: "The believer is not one who eats his fill while his neighbor goes hungry."
            },
            {
                arabic: "مَنْ لَا يَرْحَمُ لَا يُرْحَمُ",
                english: "Whoever does not show mercy will not be shown mercy."
            },
            {
                arabic: "لَيْسَ الشَّدِيدُ بِالصُّرَعَةِ، إِنَّمَا الشَّدِيدُ الَّذِي يَمْلِكُ نَفْسَهُ عِنْدَ الْغَضَبِ",
                english: "The strong person is not the one who can wrestle someone else down. The strong person is the one who can control himself when he is angry."
            }
        ];

        this.initializeEventListeners();
        this.loadProgress();
        this.updateDisplay();
        this.updateIslamicContent();
        this.updateMotivationalQuote(); // Ensure this is also called on load
    }

    initializeEventListeners() {
        this.startBtn.addEventListener("click", () => this.toggleTimer());
        this.pauseBtn.addEventListener("click", () => this.pauseTimer());
        this.resetBtn.addEventListener("click", () => this.resetTimer());

        this.increaseBtn.addEventListener("click", () => this.adjustTime(1));
        this.decreaseBtn.addEventListener("click", () => this.adjustTime(-1));

        this.skipBreaksCheckbox.addEventListener("change", (e) => {
            this.skipBreaks = e.target.checked;
        });

        this.volumeSlider.addEventListener("input", () => {
            this.volume = parseFloat(this.volumeSlider.value);
            this.volumeValue.textContent = this.volume.toFixed(1);
        });
    }

    // Save progress to localStorage
    saveProgress() {
        const progress = {
            completedMinutes: this.completedMinutes,
            sessionsCount: this.sessionsCount,
            streakDays: this.streakDays,
            lastSessionDate: this.lastSessionDate // Save the date string
        };
        localStorage.setItem('islamicFocusTimerProgress', JSON.stringify(progress));
    }

    // Load progress from localStorage
    loadProgress() {
        const savedProgress = localStorage.getItem('islamicFocusTimerProgress');
        if (savedProgress) {
            const progress = JSON.parse(savedProgress);
            this.completedMinutes = progress.completedMinutes || 0;
            this.sessionsCount = progress.sessionsCount || 0;
            this.streakDays = progress.streakDays || 0;
            this.lastSessionDate = progress.lastSessionDate || null; // Load the date string

            // Recalculate streak based on current date vs last session date on load
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            if (this.lastSessionDate) {
                const lastDate = new Date(this.lastSessionDate);
                lastDate.setHours(0, 0, 0, 0); // Normalize to start of day

                const diffTime = today.getTime() - lastDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 1) { // If it's the day after the last session, continue streak
                    // Streak already loaded from storage, no change needed unless it was 0 for some reason.
                    // If the app was closed and opened on a consecutive day, the streak should already be accurate from saveProgress.
                } else if (diffDays > 1) { // If more than one day passed, break the streak
                    this.streakDays = 0; // Reset streak if broken
                }
                // If diffDays is 0 (same day), streak remains as loaded.
            } else {
                this.streakDays = 0; // No last session, no streak
            }
        }
    }

    formatTime(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    updateDisplay() {
        this.timerDisplay.textContent = this.formatTime(this.remainingTime);
        this.progressValue.textContent = Math.ceil(this.remainingTime / 60);

        const totalDuration = this.isBreakTime ? this.breakDuration : this.sessionDuration;
        const progress = 1 - (this.remainingTime / totalDuration);
        // Calculate circumference (2 * PI * R). R is 80, so 2 * 3.14159 * 80 = 502.65...
        const circumference = 2 * Math.PI * 80;
        const dashOffset = circumference - (circumference * progress);
        this.progressCircle.style.strokeDashoffset = dashOffset;

        this.completedSpan.textContent = this.completedMinutes;
        this.sessionsSpan.textContent = this.sessionsCount;
        this.streakSpan.textContent = this.streakDays;
        // Simple focus score: 100% if all sessions were completed without manual reset mid-session
        // For a more advanced score, you'd need to track partial sessions or manual resets.
        this.focusScoreSpan.textContent = this.sessionsCount > 0 ? '100' : '0';
    }

    updateIslamicContent() {
        // Randomly select between dua, quran verse, or hadith
        const contentTypes = ['dua', 'quran', 'hadith'];
        const selectedType = contentTypes[Math.floor(Math.random() * contentTypes.length)];

        let content;
        switch (selectedType) {
            case 'dua':
                content = this.duas[Math.floor(Math.random() * this.duas.length)];
                break;
            case 'quran':
                content = this.quranVerses[Math.floor(Math.random() * this.quranVerses.length)];
                break;
            case 'hadith':
                content = this.hadiths[Math.floor(Math.random() * this.hadiths.length)];
                break;
        }

        this.duaText.innerHTML = `
            <div class="arabic" style="font-size: 20px; margin-bottom: 8px;">${content.arabic}</div>
            <div class="english">"${content.english}"</div>
        `;
    }

    updateMotivationalQuote() {
        const quote = this.hadiths[Math.floor(Math.random() * this.hadiths.length)];
        document.querySelector('.motivation-quote').innerHTML = `
            <div class="arabic" style="font-size: 16px; margin-bottom: 8px;">${quote.arabic}</div>
            <div>"${quote.english}" - Prophet Muhammad ﷺ</div>
        `;
    }

    adjustTime(minutes) {
        if (this.isRunning || this.isBreakTime) return;

        const newDuration = this.sessionDuration + (minutes * 60);
        // Ensure duration is between 5 minutes (300s) and 60 minutes (3600s)
        if (newDuration >= 5 * 60 && newDuration <= 60 * 60) {
            this.sessionDuration = newDuration;
            this.remainingTime = this.sessionDuration;
            this.updateDisplay();
        }
    }

    toggleTimer() {
        if (this.isRunning) {
            this.stopTimer(); // This effectively pauses and resets button state
        } else {
            this.startTimer();
        }
    }

    startTimer() {
        this.isRunning = true;
        this.isPaused = false;

        this.startBtn.style.display = 'none';
        this.pauseBtn.style.display = 'inline-block';
        this.resetBtn.style.display = 'inline-block';
        this.increaseBtn.disabled = true; // Disable time adjustment during session
        this.decreaseBtn.disabled = true;

        this.statusText.textContent = this.isBreakTime ? "Break Time" : "Focus Time";
        this.timerLabel.textContent = this.isBreakTime ? "Break Session" : "Focus Session";
        this.mainPanel.classList.add('active-session');
        this.timerDisplay.classList.add('pulse');

        this.timerInterval = setInterval(() => {
            this.remainingTime--;
            this.updateDisplay();

            if (this.remainingTime <= 0) {
                this.completeSession();
            }
        }, 1000);
    }

    pauseTimer() {
        if (this.isRunning) {
            clearInterval(this.timerInterval);
            this.isRunning = false;
            this.isPaused = true;
            this.pauseBtn.textContent = 'Resume';
            this.statusText.textContent = 'Paused';
            this.timerDisplay.classList.remove('pulse');
        } else if (this.isPaused) {
            this.startTimer();
            this.pauseBtn.textContent = 'Pause';
        }
    }

    stopTimer() {
        clearInterval(this.timerInterval);
        this.isRunning = false;
        this.isPaused = false;

        this.startBtn.style.display = 'inline-block';
        this.pauseBtn.style.display = 'none';
        this.resetBtn.style.display = 'none';
        this.increaseBtn.disabled = false; // Enable time adjustment when stopped
        this.decreaseBtn.disabled = false;

        this.statusText.textContent = "Ready to Focus";
        this.mainPanel.classList.remove('active-session');
        this.timerDisplay.classList.remove('pulse');
    }

    resetTimer() {
        this.stopTimer();
        this.remainingTime = this.isBreakTime ? this.breakDuration : this.sessionDuration;
        this.updateDisplay();
        this.statusText.textContent = "Ready to Focus";
        this.timerLabel.textContent = "Focus Session";
        this.isBreakTime = false; // Ensure it resets to focus state
    }

    completeSession() {
        this.stopTimer();
        this.playNotificationSound();

        if (this.isBreakTime) {
            // Break completed, back to focus
            this.isBreakTime = false;
            this.remainingTime = this.sessionDuration;
            this.showNotification("Break Complete!", "Ready for your next focus session?");
            this.statusText.textContent = "Break Complete";
            this.timerLabel.textContent = "Focus Session";
        } else {
            // Focus session completed
            const minutesCompleted = Math.floor(this.sessionDuration / 60);
            this.completedMinutes += minutesCompleted;
            this.sessionsCount++;

            // Streak Logic - revised for clarity and accuracy
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day for comparison

            if (this.lastSessionDate) {
                const lastDate = new Date(this.lastSessionDate);
                lastDate.setHours(0, 0, 0, 0); // Normalize to start of day

                const diffTime = today.getTime() - lastDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    // Same day, continue current streak. Do not increment streak.
                } else if (diffDays === 1) {
                    // Consecutive day, increment streak.
                    this.streakDays++;
                } else {
                    // More than one day passed, streak broken, start new streak.
                    this.streakDays = 1;
                }
            } else {
                // First session ever, start streak at 1.
                this.streakDays = 1;
            }
            this.lastSessionDate = today.toDateString(); // Update last session date for next check

            if (this.skipBreaks) {
                this.remainingTime = this.sessionDuration;
                this.showNotification("Session Complete!", "Great work! Ready for another session?");
                this.statusText.textContent = "Session Complete";
            } else {
                // Start break
                this.isBreakTime = true;
                this.remainingTime = this.breakDuration;
                this.showNotification("Focus Complete!", "Time for a well-deserved break!");
                this.statusText.textContent = "Break Time";
                this.timerLabel.textContent = "Break Session";
            }
        }

        this.saveProgress();
        this.updateDisplay();
        this.updateIslamicContent();
        this.updateMotivationalQuote();
    }

    playNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);

            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(this.volume * 0.3, audioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (error) {
            console.warn('Audio notification not available:', error); // Changed to warn
        }
    }

    showNotification(title, message) {
        const notification = document.getElementById("notification");
        const notificationTitle = document.getElementById("notificationTitle");
        const notificationMessage = document.getElementById("notificationMessage");

        notificationTitle.textContent = title;
        notificationMessage.textContent = message;

        notification.classList.add("show");

        setTimeout(() => {
            notification.classList.remove("show");
        }, 5000);
    }
}

// Initialize the timer when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new IslamicFocusTimer();

    // Add twinkling stars effect
    function createStar() {
        const star = document.createElement('div');
        star.style.cssText = `
            position: fixed;
            width: 2px;
            height: 2px;
            background: #d4af37;
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        `;

        star.style.left = Math.random() * window.innerWidth + 'px';
        star.style.top = Math.random() * window.innerHeight + 'px';

        document.body.appendChild(star);

        star.animate([
            { opacity: 0, transform: 'scale(0)' },
            { opacity: 0.8, transform: 'scale(1)' },
            { opacity: 0, transform: 'scale(0)' }
        ], {
            duration: 2000 + Math.random() * 3000,
            easing: 'ease-in-out'
        }).addEventListener('finish', () => {
            star.remove();
        });
    }

    // You might want to consider rate limiting this or linking it to user activity
    // to avoid excessive DOM manipulation on slower devices.
    // For now, keeping it as is.
    setInterval(createStar, 1500);

    // Add floating animation (CSS moved here for completeness as per previous discussion)
    const style = document.createElement('style');
    style.textContent = `
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .timer-display.pulse {
            animation: islamicPulse 2s infinite, breathe 4s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .progress-circle svg {
            filter: drop-shadow(0 0 10px rgba(184, 134, 11, 0.3));
        }

        .active-session .progress-circle {
            animation: glow 3s ease-in-out infinite alternate;
        }

        /* Basic styles for the notification popup - ensure these are in your main CSS or added here */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            z-index: 1000;
            text-align: center;
            font-family: 'Noto Sans Arabic', sans-serif;
        }

        .notification.show {
            opacity: 1;
            visibility: visible;
        }

        .notification-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #d4af37;
        }
    `;
    document.head.appendChild(style);
});
